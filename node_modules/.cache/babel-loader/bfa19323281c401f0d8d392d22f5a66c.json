{"ast":null,"code":"import \"antd/es/message/style\";\nimport _message from \"antd/es/message\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport \"antd/es/popconfirm/style\";\nimport _Popconfirm from \"antd/es/popconfirm\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _objectWithoutProperties from \"@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _objectSpread from \"@babel/runtime/helpers/esm/objectSpread2\";\nimport _typeof from \"@babel/runtime/helpers/esm/typeof\";\nvar _excluded = [\"map_row_parentKey\", \"map_row_key\"],\n    _excluded2 = [\"map_row_key\"];\n/* eslint-disable react-hooks/exhaustive-deps */\n\nimport React, { useCallback, useContext, useMemo, useRef, useState } from 'react';\nimport useMergedState from \"rc-util/es/hooks/useMergedState\";\nimport useLazyKVMap from \"antd/es/table/hooks/useLazyKVMap\";\nimport { LoadingOutlined } from '@ant-design/icons';\nimport { useIntl } from '@ant-design/pro-provider';\nimport set from \"rc-util/es/utils/set\";\nimport useMountMergeState from '../useMountMergeState';\nimport ProFormContext from '../components/ProFormContext';\nimport { merge } from '../merge';\nimport usePrevious from '../hooks/usePrevious';\nimport get from \"rc-util/es/utils/get\";\nimport useDeepCompareEffect from '../hooks/useDeepCompareEffect';\nexport var recordKeyToString = function recordKeyToString(rowKey) {\n  if (Array.isArray(rowKey)) return rowKey.join(',');\n  return rowKey;\n};\n/**\n * 使用map 来删除数据，性能一般 但是准确率比较高\n *\n * @param params\n * @param action\n */\n\nfunction editableRowByKey(params, action) {\n  var _recordKeyToString;\n\n  var getRowKey = params.getRowKey,\n      row = params.row,\n      data = params.data,\n      childrenColumnName = params.childrenColumnName;\n  var key = (_recordKeyToString = recordKeyToString(params.key)) === null || _recordKeyToString === void 0 ? void 0 : _recordKeyToString.toString();\n  var kvMap = new Map();\n  /**\n   * 打平这个数组\n   *\n   * @param records\n   * @param parentKey\n   */\n\n  function dig(records, map_row_parentKey, map_row_index) {\n    records.forEach(function (record, index) {\n      var eachIndex = (map_row_index || 0) * 10 + index;\n      var recordKey = getRowKey(record, eachIndex).toString(); // children 取在前面方便拼的时候按照反顺序放回去\n\n      if (record && _typeof(record) === 'object' && childrenColumnName in record) {\n        dig(record[childrenColumnName] || [], recordKey, eachIndex);\n      }\n\n      var newRecord = _objectSpread(_objectSpread({}, record), {}, {\n        map_row_key: recordKey,\n        children: undefined,\n        map_row_parentKey: map_row_parentKey\n      });\n\n      delete newRecord.children;\n\n      if (!map_row_parentKey) {\n        delete newRecord.map_row_parentKey;\n      }\n\n      kvMap.set(recordKey, newRecord);\n    });\n  }\n\n  if (action === 'top') {\n    kvMap.set(key, _objectSpread(_objectSpread({}, kvMap.get(key)), row));\n  }\n\n  dig(data);\n\n  if (action === 'update') {\n    kvMap.set(key, _objectSpread(_objectSpread({}, kvMap.get(key)), row));\n  }\n\n  if (action === 'delete') {\n    kvMap.delete(key);\n  }\n\n  var fill = function fill(map) {\n    var kvArrayMap = new Map();\n    var kvSource = [];\n    map.forEach(function (value) {\n      if (value.map_row_parentKey) {\n        // @ts-ignore\n        var map_row_parentKey = value.map_row_parentKey,\n            map_row_key = value.map_row_key,\n            reset = _objectWithoutProperties(value, _excluded);\n\n        if (kvArrayMap.has(map_row_key)) {\n          reset[childrenColumnName] = kvArrayMap.get(map_row_key);\n        }\n\n        kvArrayMap.set(map_row_parentKey, [].concat(_toConsumableArray(kvArrayMap.get(map_row_parentKey) || []), [reset]));\n      }\n    });\n    map.forEach(function (value) {\n      if (!value.map_row_parentKey) {\n        // @ts-ignore\n        var map_row_key = value.map_row_key,\n            rest = _objectWithoutProperties(value, _excluded2);\n\n        if (kvArrayMap.has(map_row_key)) {\n          var item = _objectSpread(_objectSpread({}, rest), {}, _defineProperty({}, childrenColumnName, kvArrayMap.get(map_row_key)));\n\n          kvSource.push(item);\n          return;\n        }\n\n        kvSource.push(rest);\n      }\n    });\n    return kvSource;\n  };\n\n  var source = fill(kvMap);\n  return source;\n}\n/**\n * 保存按钮的dom\n *\n * @param ActionRenderConfig\n */\n\n\nexport function SaveEditableAction(_ref) {\n  var recordKey = _ref.recordKey,\n      onSave = _ref.onSave,\n      form = _ref.form,\n      row = _ref.row,\n      children = _ref.children,\n      newLineConfig = _ref.newLineConfig,\n      editorType = _ref.editorType,\n      tableName = _ref.tableName;\n  var context = useContext(ProFormContext);\n\n  var _useMountMergeState = useMountMergeState(false),\n      _useMountMergeState2 = _slicedToArray(_useMountMergeState, 2),\n      loading = _useMountMergeState2[0],\n      setLoading = _useMountMergeState2[1];\n\n  return /*#__PURE__*/React.createElement(\"a\", {\n    key: \"save\",\n    onClick: /*#__PURE__*/function () {\n      var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(e) {\n        var _context$getFieldForm, isMapEditor, namePath, fields, data, res;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                e.stopPropagation();\n                e.preventDefault();\n                _context.prev = 2;\n                isMapEditor = editorType === 'Map';\n                namePath = [tableName, recordKey].map(function (key) {\n                  return key === null || key === void 0 ? void 0 : key.toString();\n                }).flat(1).filter(Boolean);\n                setLoading(true); // @ts-expect-error\n\n                _context.next = 8;\n                return form.validateFields(namePath, {\n                  recursive: true\n                });\n\n              case 8:\n                fields = ((_context$getFieldForm = context.getFieldFormatValue) === null || _context$getFieldForm === void 0 ? void 0 : _context$getFieldForm.call(context, namePath)) || form.getFieldValue(namePath);\n                data = isMapEditor ? set({}, namePath, fields, true) : fields; // 获取数据并保存\n\n                _context.next = 12;\n                return onSave === null || onSave === void 0 ? void 0 : onSave(recordKey, // 如果是 map 模式，fields 就是一个值，所以需要set 到对象中\n                // 数据模式 fields 是一个对象，所以不需要\n                merge({}, row, data), row, newLineConfig);\n\n              case 12:\n                res = _context.sent;\n                setLoading(false);\n                return _context.abrupt(\"return\", res);\n\n              case 17:\n                _context.prev = 17;\n                _context.t0 = _context[\"catch\"](2); // eslint-disable-next-line no-console\n\n                console.log(_context.t0);\n                setLoading(false);\n                return _context.abrupt(\"return\", null);\n\n              case 22:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[2, 17]]);\n      }));\n\n      return function (_x) {\n        return _ref2.apply(this, arguments);\n      };\n    }()\n  }, loading ? /*#__PURE__*/React.createElement(LoadingOutlined, {\n    style: {\n      marginRight: 8\n    }\n  }) : null, children || '保存');\n}\n/**\n * 删除按钮 dom\n *\n * @param ActionRenderConfig\n */\n\nexport var DeleteEditableAction = function DeleteEditableAction(_ref3) {\n  var recordKey = _ref3.recordKey,\n      onDelete = _ref3.onDelete,\n      row = _ref3.row,\n      children = _ref3.children,\n      deletePopconfirmMessage = _ref3.deletePopconfirmMessage,\n      cancelEditable = _ref3.cancelEditable;\n\n  var _useMountMergeState3 = useMountMergeState(false),\n      _useMountMergeState4 = _slicedToArray(_useMountMergeState3, 2),\n      loading = _useMountMergeState4[0],\n      setLoading = _useMountMergeState4[1];\n\n  var onConfirm = /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var res;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.prev = 0;\n              setLoading(true);\n              _context2.next = 4;\n              return onDelete === null || onDelete === void 0 ? void 0 : onDelete(recordKey, row);\n\n            case 4:\n              res = _context2.sent;\n              setLoading(false);\n              setTimeout(function () {\n                cancelEditable(recordKey);\n              }, 0);\n              return _context2.abrupt(\"return\", res);\n\n            case 10:\n              _context2.prev = 10;\n              _context2.t0 = _context2[\"catch\"](0); // eslint-disable-next-line no-console\n\n              console.log(_context2.t0);\n              setLoading(false);\n              return _context2.abrupt(\"return\", null);\n\n            case 15:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[0, 10]]);\n    }));\n\n    return function onConfirm() {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  return children !== false ? /*#__PURE__*/React.createElement(_Popconfirm, {\n    key: \"delete\",\n    title: deletePopconfirmMessage,\n    onConfirm: onConfirm\n  }, /*#__PURE__*/React.createElement(\"a\", null, loading ? /*#__PURE__*/React.createElement(LoadingOutlined, {\n    style: {\n      marginRight: 8\n    }\n  }) : null, children || '删除')) : null;\n};\n\nvar CancelEditableAction = function CancelEditableAction(props) {\n  var recordKey = props.recordKey,\n      tableName = props.tableName,\n      newLineConfig = props.newLineConfig,\n      form = props.form,\n      editorType = props.editorType,\n      onCancel = props.onCancel,\n      cancelEditable = props.cancelEditable,\n      row = props.row,\n      cancelText = props.cancelText;\n  var context = useContext(ProFormContext);\n  return /*#__PURE__*/React.createElement(\"a\", {\n    key: \"cancel\",\n    onClick: /*#__PURE__*/function () {\n      var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(e) {\n        var _context$getFieldForm2;\n\n        var isMapEditor, namePath, fields, record, res;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                e.stopPropagation();\n                e.preventDefault();\n                isMapEditor = editorType === 'Map';\n                namePath = [tableName, recordKey].flat(1).filter(Boolean);\n                fields = ((_context$getFieldForm2 = context.getFieldFormatValue) === null || _context$getFieldForm2 === void 0 ? void 0 : _context$getFieldForm2.call(context, namePath)) || form.getFieldValue(namePath);\n                record = isMapEditor ? set({}, namePath, fields) : fields;\n                _context3.next = 8;\n                return onCancel === null || onCancel === void 0 ? void 0 : onCancel(recordKey, record, row, newLineConfig);\n\n              case 8:\n                res = _context3.sent;\n                cancelEditable(recordKey);\n                /** 充值为默认值，不然编辑的行会丢掉 */\n\n                form.setFieldsValue(_defineProperty({}, recordKey, isMapEditor ? get(row, namePath) : row));\n                return _context3.abrupt(\"return\", res);\n\n              case 12:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      }));\n\n      return function (_x2) {\n        return _ref5.apply(this, arguments);\n      };\n    }()\n  }, cancelText || '取消');\n};\n\nexport function defaultActionRender(row, config) {\n  var recordKey = config.recordKey,\n      newLineConfig = config.newLineConfig,\n      saveText = config.saveText,\n      deleteText = config.deleteText;\n  return [/*#__PURE__*/React.createElement(SaveEditableAction, _extends({\n    key: \"save\"\n  }, config, {\n    row: row\n  }), saveText), (newLineConfig === null || newLineConfig === void 0 ? void 0 : newLineConfig.options.recordKey) !== recordKey ? /*#__PURE__*/React.createElement(DeleteEditableAction, _extends({\n    key: \"delete\"\n  }, config, {\n    row: row\n  }), deleteText) : null, /*#__PURE__*/React.createElement(CancelEditableAction, _extends({\n    key: \"cancel\"\n  }, config, {\n    row: row\n  }))];\n}\n/**\n * 一个方便的hooks 用于维护编辑的状态\n *\n * @param props\n */\n\nfunction useEditableArray(props) {\n  var _useState = useState(undefined),\n      _useState2 = _slicedToArray(_useState, 2),\n      newLineRecordCache = _useState2[0],\n      setNewLineRecordCache = _useState2[1];\n\n  var dataSourceKeyIndexMapRef = useRef(new Map());\n  var newLineRecordRef = useRef(undefined);\n  useDeepCompareEffect(function () {\n    var _props$dataSource;\n\n    var map = new Map();\n    (_props$dataSource = props.dataSource) === null || _props$dataSource === void 0 ? void 0 : _props$dataSource.forEach(function (record, index) {\n      var _recordKeyToString2;\n\n      map.set(index.toString(), recordKeyToString(props.getRowKey(record, -1)));\n      map.set((_recordKeyToString2 = recordKeyToString(props.getRowKey(record, -1))) === null || _recordKeyToString2 === void 0 ? void 0 : _recordKeyToString2.toString(), index.toString());\n    });\n    dataSourceKeyIndexMapRef.current = map;\n  }, [props.dataSource]); // 这里这么做是为了存上次的状态，不然每次存一下再拿\n\n  newLineRecordRef.current = newLineRecordCache;\n  var editableType = props.type || 'single';\n\n  var _useLazyKVMap = useLazyKVMap(props.dataSource, 'children', props.getRowKey),\n      _useLazyKVMap2 = _slicedToArray(_useLazyKVMap, 1),\n      getRecordByKey = _useLazyKVMap2[0];\n\n  var _useMergedState = useMergedState([], {\n    value: props.editableKeys,\n    onChange: props.onChange ? function (keys) {\n      var _props$onChange;\n\n      props === null || props === void 0 ? void 0 : (_props$onChange = props.onChange) === null || _props$onChange === void 0 ? void 0 : _props$onChange.call(props, // 计算编辑的key\n      keys, // 计算编辑的行\n      keys.map(function (key) {\n        return getRecordByKey(key);\n      }));\n    } : undefined\n  }),\n      _useMergedState2 = _slicedToArray(_useMergedState, 2),\n      editableKeys = _useMergedState2[0],\n      setEditableRowKeys = _useMergedState2[1];\n  /** 一个用来标志的set 提供了方便的 api 来去重什么的 */\n\n\n  var editableKeysSet = useMemo(function () {\n    var keys = editableType === 'single' ? editableKeys === null || editableKeys === void 0 ? void 0 : editableKeys.slice(0, 1) : editableKeys;\n    return new Set(keys);\n  }, [(editableKeys || []).join(','), editableType]);\n  var editableKeysRef = usePrevious(editableKeys);\n  /** 这行是不是编辑状态 */\n\n  var isEditable = useCallback(function (row) {\n    var _props$getRowKey, _props$getRowKey$toSt, _props$getRowKey2, _props$getRowKey2$toS; // 为了兼容一下name 模式的 indexKey，所以需要判断两次，一次是index，一次是没有 index 的\n\n\n    var recordKeyOrIndex = (_props$getRowKey = props.getRowKey(row, row.index)) === null || _props$getRowKey === void 0 ? void 0 : (_props$getRowKey$toSt = _props$getRowKey.toString) === null || _props$getRowKey$toSt === void 0 ? void 0 : _props$getRowKey$toSt.call(_props$getRowKey); // 这里是不设置 index 的地方\n\n    var recordKey = (_props$getRowKey2 = props.getRowKey(row, -1)) === null || _props$getRowKey2 === void 0 ? void 0 : (_props$getRowKey2$toS = _props$getRowKey2.toString) === null || _props$getRowKey2$toS === void 0 ? void 0 : _props$getRowKey2$toS.call(_props$getRowKey2); // 都转化为了字符串，不然 number 和 string\n\n    var stringEditableKeys = editableKeys.map(function (key) {\n      return key.toString();\n    });\n    var stringEditableKeysRef = (editableKeysRef === null || editableKeysRef === void 0 ? void 0 : editableKeysRef.map(function (key) {\n      return key.toString();\n    })) || [];\n    var preIsEditable = props.tableName && !!(stringEditableKeysRef === null || stringEditableKeysRef === void 0 ? void 0 : stringEditableKeysRef.includes(recordKey)) || !!(stringEditableKeysRef === null || stringEditableKeysRef === void 0 ? void 0 : stringEditableKeysRef.includes(recordKeyOrIndex));\n    return {\n      recordKey: recordKey,\n      isEditable: props.tableName && (stringEditableKeys === null || stringEditableKeys === void 0 ? void 0 : stringEditableKeys.includes(recordKey)) || (stringEditableKeys === null || stringEditableKeys === void 0 ? void 0 : stringEditableKeys.includes(recordKeyOrIndex)),\n      preIsEditable: preIsEditable\n    };\n  }, [(editableKeys || []).join(',')]);\n  /**\n   * 进入编辑状态\n   *\n   * @param recordKey\n   */\n\n  var startEditable = function startEditable(recordKey) {\n    // 如果是单行的话，不允许多行编辑\n    if (editableKeysSet.size > 0 && editableType === 'single') {\n      _message.warn(props.onlyOneLineEditorAlertMessage || '只能同时编辑一行');\n\n      return false;\n    }\n\n    editableKeysSet.add(recordKey);\n    setEditableRowKeys(Array.from(editableKeysSet));\n    return true;\n  };\n  /**\n   * 退出编辑状态\n   *\n   * @param recordKey\n   */\n\n\n  var cancelEditable = function cancelEditable(recordKey, needReTry) {\n    var relayKey = recordKeyToString(recordKey).toString();\n    var key = dataSourceKeyIndexMapRef.current.get(relayKey);\n    /** 如果没找到key，转化一下再去找 */\n\n    if (!editableKeysSet.has(relayKey) && key && (needReTry !== null && needReTry !== void 0 ? needReTry : true) && props.tableName) {\n      cancelEditable(key, false);\n      return;\n    }\n    /** 如果这个是 new Line 直接删除 */\n\n\n    if (newLineRecordCache && newLineRecordCache.options.recordKey === recordKey) {\n      setNewLineRecordCache(undefined);\n    }\n\n    editableKeysSet.delete(relayKey);\n    editableKeysSet.delete(recordKeyToString(recordKey));\n    setEditableRowKeys(Array.from(editableKeysSet));\n    return true;\n  };\n\n  var onValuesChange = function onValuesChange(value, values) {\n    var _Object$keys$pop;\n\n    if (!props.onValuesChange) {\n      return;\n    }\n\n    var dataSource = props.dataSource; // 这里是把正在编辑中的所有表单数据都修改掉\n    // 不然会用 props 里面的 dataSource，数据只有正在编辑中的\n    // Object.keys(get(values, [props.tableName || ''].flat(1)) || values).forEach((recordKey) => {\n\n    editableKeys.forEach(function (eachRecordKey) {\n      if ((newLineRecordCache === null || newLineRecordCache === void 0 ? void 0 : newLineRecordCache.options.recordKey) === eachRecordKey) return;\n      var recordKey = eachRecordKey.toString(); // 如果数据在这个 form 中没有展示，也不显示\n\n      var editRow = get(values, [props.tableName || '', recordKey].flat(1).filter(function (key) {\n        return key || key === 0;\n      }));\n\n      if (!editRow) {\n        var _dataSourceKeyIndexMa;\n\n        recordKey = ((_dataSourceKeyIndexMa = dataSourceKeyIndexMapRef.current.get(recordKeyToString(recordKey))) === null || _dataSourceKeyIndexMa === void 0 ? void 0 : _dataSourceKeyIndexMa.toString()) || '';\n        editRow = get(values, [props.tableName || '', recordKey].flat(1).filter(function (key) {\n          return key || key === 0;\n        }));\n      }\n\n      if (!editRow) return;\n      dataSource = editableRowByKey({\n        data: dataSource,\n        getRowKey: props.getRowKey,\n        row: editRow,\n        key: recordKey,\n        childrenColumnName: props.childrenColumnName || 'children'\n      }, 'update');\n    });\n    var relayValue = props.tableName ? get(value, [props.tableName || ''].flat(1)) : value;\n    var recordKey = (_Object$keys$pop = Object.keys(relayValue || {}).pop()) === null || _Object$keys$pop === void 0 ? void 0 : _Object$keys$pop.toString(); //从form 和 cache 中取得数据\n\n    var newLineRecordData = _objectSpread(_objectSpread({}, newLineRecordCache === null || newLineRecordCache === void 0 ? void 0 : newLineRecordCache.defaultValue), get(values, [props.tableName || '', recordKey.toString()].flat(1).filter(function (key) {\n      return key || key === 0;\n    })));\n    /** 如果已经在 dataSource 中存在了，直接 find */\n\n\n    var editRow = dataSourceKeyIndexMapRef.current.has(recordKeyToString(recordKey)) ? dataSource.find(function (item, index) {\n      var _props$getRowKey3;\n\n      var key = (_props$getRowKey3 = props.getRowKey(item, index)) === null || _props$getRowKey3 === void 0 ? void 0 : _props$getRowKey3.toString();\n      return key === recordKey;\n    }) : newLineRecordData;\n    props.onValuesChange(editRow || newLineRecordData, dataSource);\n  };\n  /**\n   * 同时只能支持一行,取消之后数据消息，不会触发 dataSource\n   *\n   * @param row\n   * @param options\n   * @name 增加新的行\n   */\n\n\n  var addEditRecord = function addEditRecord(row, options) {\n    // 暂时不支持多行新增\n    if (newLineRecordRef.current) {\n      _message.warn(props.onlyAddOneLineAlertMessage || '只能新增一行');\n\n      return false;\n    } // 如果是单行的话，不允许多行编辑\n\n\n    if (editableKeysSet.size > 0 && editableType === 'single') {\n      _message.warn(props.onlyOneLineEditorAlertMessage || '只能同时编辑一行');\n\n      return false;\n    } // 防止多次渲染\n\n\n    var recordKey = props.getRowKey(row, props.dataSource.length);\n    editableKeysSet.add(recordKey);\n    setEditableRowKeys(Array.from(editableKeysSet)); // 如果是dataSource 新增模式的话，取消再开始编辑，\n    // 这样就可以把新增到 dataSource的数据进入编辑模式了\n    // [a,b,cache] => [a,b,c]\n\n    if ((options === null || options === void 0 ? void 0 : options.newRecordType) === 'dataSource') {\n      var _recordKeyToString3;\n\n      var actionProps = {\n        data: props.dataSource,\n        getRowKey: props.getRowKey,\n        row: _objectSpread(_objectSpread({}, row), {}, {\n          map_row_parentKey: (options === null || options === void 0 ? void 0 : options.parentKey) ? (_recordKeyToString3 = recordKeyToString(options === null || options === void 0 ? void 0 : options.parentKey)) === null || _recordKeyToString3 === void 0 ? void 0 : _recordKeyToString3.toString() : undefined\n        }),\n        key: recordKey,\n        childrenColumnName: props.childrenColumnName || 'children'\n      };\n      props.setDataSource(editableRowByKey(actionProps, (options === null || options === void 0 ? void 0 : options.position) === 'top' ? 'top' : 'update'));\n    } else {\n      setNewLineRecordCache({\n        defaultValue: row,\n        options: _objectSpread(_objectSpread({}, options), {}, {\n          recordKey: recordKey\n        })\n      });\n    }\n\n    return true;\n  }; // Internationalization\n\n\n  var intl = useIntl();\n  var saveText = (props === null || props === void 0 ? void 0 : props.saveText) || intl.getMessage('editableTable.action.save', '保存');\n  var deleteText = (props === null || props === void 0 ? void 0 : props.deleteText) || intl.getMessage('editableTable.action.delete', '删除');\n  var cancelText = (props === null || props === void 0 ? void 0 : props.cancelText) || intl.getMessage('editableTable.action.cancel', '取消');\n\n  var actionRender = function actionRender(row, form) {\n    var key = props.getRowKey(row, row.index);\n    var config = {\n      saveText: saveText,\n      cancelText: cancelText,\n      deleteText: deleteText,\n      addEditRecord: addEditRecord,\n      recordKey: key,\n      cancelEditable: cancelEditable,\n      index: row.index,\n      tableName: props.tableName,\n      newLineConfig: newLineRecordCache,\n      onCancel: function () {\n        var _onCancel = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(recordKey, editRow, originRow, newLine) {\n          var _props$onCancel;\n\n          var res;\n          return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n            while (1) {\n              switch (_context4.prev = _context4.next) {\n                case 0:\n                  _context4.next = 2;\n                  return props === null || props === void 0 ? void 0 : (_props$onCancel = props.onCancel) === null || _props$onCancel === void 0 ? void 0 : _props$onCancel.call(props, recordKey, editRow, originRow, newLine);\n\n                case 2:\n                  res = _context4.sent;\n                  return _context4.abrupt(\"return\", res);\n\n                case 4:\n                case \"end\":\n                  return _context4.stop();\n              }\n            }\n          }, _callee4);\n        }));\n\n        function onCancel(_x3, _x4, _x5, _x6) {\n          return _onCancel.apply(this, arguments);\n        }\n\n        return onCancel;\n      }(),\n      onDelete: function () {\n        var _onDelete = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(recordKey, editRow) {\n          var _props$onDelete;\n\n          var actionProps, res;\n          return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n            while (1) {\n              switch (_context5.prev = _context5.next) {\n                case 0:\n                  actionProps = {\n                    data: props.dataSource,\n                    getRowKey: props.getRowKey,\n                    row: editRow,\n                    key: recordKey,\n                    childrenColumnName: props.childrenColumnName || 'children'\n                  };\n                  _context5.next = 3;\n                  return props === null || props === void 0 ? void 0 : (_props$onDelete = props.onDelete) === null || _props$onDelete === void 0 ? void 0 : _props$onDelete.call(props, recordKey, editRow);\n\n                case 3:\n                  res = _context5.sent;\n                  props.setDataSource(editableRowByKey(actionProps, 'delete'));\n                  return _context5.abrupt(\"return\", res);\n\n                case 6:\n                case \"end\":\n                  return _context5.stop();\n              }\n            }\n          }, _callee5);\n        }));\n\n        function onDelete(_x7, _x8) {\n          return _onDelete.apply(this, arguments);\n        }\n\n        return onDelete;\n      }(),\n      onSave: function () {\n        var _onSave = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(recordKey, editRow, originRow, newLine) {\n          var _props$onSave;\n\n          var _ref6, options, res, actionProps;\n\n          return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n            while (1) {\n              switch (_context6.prev = _context6.next) {\n                case 0:\n                  _ref6 = newLine || {}, options = _ref6.options;\n                  _context6.next = 3;\n                  return props === null || props === void 0 ? void 0 : (_props$onSave = props.onSave) === null || _props$onSave === void 0 ? void 0 : _props$onSave.call(props, recordKey, editRow, originRow, newLine);\n\n                case 3:\n                  res = _context6.sent; // 保存时解除编辑模式\n\n                  cancelEditable(recordKey);\n\n                  if (!(newLine && (options === null || options === void 0 ? void 0 : options.recordKey) === recordKey)) {\n                    _context6.next = 8;\n                    break;\n                  }\n\n                  if ((options === null || options === void 0 ? void 0 : options.position) === 'top') {\n                    props.setDataSource([editRow].concat(_toConsumableArray(props.dataSource)));\n                  } else {\n                    props.setDataSource([].concat(_toConsumableArray(props.dataSource), [editRow]));\n                  }\n\n                  return _context6.abrupt(\"return\", res);\n\n                case 8:\n                  actionProps = {\n                    data: props.dataSource,\n                    getRowKey: props.getRowKey,\n                    row: editRow,\n                    key: recordKey,\n                    childrenColumnName: props.childrenColumnName || 'children'\n                  };\n                  props.setDataSource(editableRowByKey(actionProps, 'update'));\n                  return _context6.abrupt(\"return\", res);\n\n                case 11:\n                case \"end\":\n                  return _context6.stop();\n              }\n            }\n          }, _callee6);\n        }));\n\n        function onSave(_x9, _x10, _x11, _x12) {\n          return _onSave.apply(this, arguments);\n        }\n\n        return onSave;\n      }(),\n      form: form,\n      editableKeys: editableKeys,\n      setEditableRowKeys: setEditableRowKeys,\n      deletePopconfirmMessage: props.deletePopconfirmMessage || '删除此行？'\n    };\n    var defaultDoms = defaultActionRender(row, config);\n    if (props.actionRender) return props.actionRender(row, config, {\n      save: defaultDoms[0],\n      delete: defaultDoms[1],\n      cancel: defaultDoms[2]\n    });\n    return defaultDoms;\n  };\n\n  return {\n    editableKeys: editableKeys,\n    setEditableRowKeys: setEditableRowKeys,\n    isEditable: isEditable,\n    actionRender: actionRender,\n    startEditable: startEditable,\n    cancelEditable: cancelEditable,\n    addEditRecord: addEditRecord,\n    newLineRecord: newLineRecordCache,\n    preEditableKeys: editableKeysRef,\n    onValuesChange: onValuesChange\n  };\n}\n\nexport default useEditableArray;","map":{"version":3,"sources":["C:/web/my-app/node_modules/@ant-design/pro-utils/es/useEditableArray/index.js"],"names":["_message","_extends","_Popconfirm","_regeneratorRuntime","_asyncToGenerator","_slicedToArray","_defineProperty","_toConsumableArray","_objectWithoutProperties","_objectSpread","_typeof","_excluded","_excluded2","React","useCallback","useContext","useMemo","useRef","useState","useMergedState","useLazyKVMap","LoadingOutlined","useIntl","set","useMountMergeState","ProFormContext","merge","usePrevious","get","useDeepCompareEffect","recordKeyToString","rowKey","Array","isArray","join","editableRowByKey","params","action","_recordKeyToString","getRowKey","row","data","childrenColumnName","key","toString","kvMap","Map","dig","records","map_row_parentKey","map_row_index","forEach","record","index","eachIndex","recordKey","newRecord","map_row_key","children","undefined","delete","fill","map","kvArrayMap","kvSource","value","reset","has","concat","rest","item","push","source","SaveEditableAction","_ref","onSave","form","newLineConfig","editorType","tableName","context","_useMountMergeState","_useMountMergeState2","loading","setLoading","createElement","onClick","_ref2","mark","_callee","e","_context$getFieldForm","isMapEditor","namePath","fields","res","wrap","_callee$","_context","prev","next","stopPropagation","preventDefault","flat","filter","Boolean","validateFields","recursive","getFieldFormatValue","call","getFieldValue","sent","abrupt","t0","console","log","stop","_x","apply","arguments","style","marginRight","DeleteEditableAction","_ref3","onDelete","deletePopconfirmMessage","cancelEditable","_useMountMergeState3","_useMountMergeState4","onConfirm","_ref4","_callee2","_callee2$","_context2","setTimeout","title","CancelEditableAction","props","onCancel","cancelText","_ref5","_callee3","_context$getFieldForm2","_callee3$","_context3","setFieldsValue","_x2","defaultActionRender","config","saveText","deleteText","options","useEditableArray","_useState","_useState2","newLineRecordCache","setNewLineRecordCache","dataSourceKeyIndexMapRef","newLineRecordRef","_props$dataSource","dataSource","_recordKeyToString2","current","editableType","type","_useLazyKVMap","_useLazyKVMap2","getRecordByKey","_useMergedState","editableKeys","onChange","keys","_props$onChange","_useMergedState2","setEditableRowKeys","editableKeysSet","slice","Set","editableKeysRef","isEditable","_props$getRowKey","_props$getRowKey$toSt","_props$getRowKey2","_props$getRowKey2$toS","recordKeyOrIndex","stringEditableKeys","stringEditableKeysRef","preIsEditable","includes","startEditable","size","warn","onlyOneLineEditorAlertMessage","add","from","needReTry","relayKey","onValuesChange","values","_Object$keys$pop","eachRecordKey","editRow","_dataSourceKeyIndexMa","relayValue","Object","pop","newLineRecordData","defaultValue","find","_props$getRowKey3","addEditRecord","onlyAddOneLineAlertMessage","length","newRecordType","_recordKeyToString3","actionProps","parentKey","setDataSource","position","intl","getMessage","actionRender","_onCancel","_callee4","originRow","newLine","_props$onCancel","_callee4$","_context4","_x3","_x4","_x5","_x6","_onDelete","_callee5","_props$onDelete","_callee5$","_context5","_x7","_x8","_onSave","_callee6","_props$onSave","_ref6","_callee6$","_context6","_x9","_x10","_x11","_x12","defaultDoms","save","cancel","newLineRecord","preEditableKeys"],"mappings":"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","sourcesContent":["import \"antd/es/message/style\";\nimport _message from \"antd/es/message\";\nimport _extends from \"@babel/runtime/helpers/esm/extends\";\nimport \"antd/es/popconfirm/style\";\nimport _Popconfirm from \"antd/es/popconfirm\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport _toConsumableArray from \"@babel/runtime/helpers/esm/toConsumableArray\";\nimport _objectWithoutProperties from \"@babel/runtime/helpers/esm/objectWithoutProperties\";\nimport _objectSpread from \"@babel/runtime/helpers/esm/objectSpread2\";\nimport _typeof from \"@babel/runtime/helpers/esm/typeof\";\nvar _excluded = [\"map_row_parentKey\", \"map_row_key\"],\n    _excluded2 = [\"map_row_key\"];\n\n/* eslint-disable react-hooks/exhaustive-deps */\nimport React, { useCallback, useContext, useMemo, useRef, useState } from 'react';\nimport useMergedState from \"rc-util/es/hooks/useMergedState\";\nimport useLazyKVMap from \"antd/es/table/hooks/useLazyKVMap\";\nimport { LoadingOutlined } from '@ant-design/icons';\nimport { useIntl } from '@ant-design/pro-provider';\nimport set from \"rc-util/es/utils/set\";\nimport useMountMergeState from '../useMountMergeState';\nimport ProFormContext from '../components/ProFormContext';\nimport { merge } from '../merge';\nimport usePrevious from '../hooks/usePrevious';\nimport get from \"rc-util/es/utils/get\";\nimport useDeepCompareEffect from '../hooks/useDeepCompareEffect';\nexport var recordKeyToString = function recordKeyToString(rowKey) {\n  if (Array.isArray(rowKey)) return rowKey.join(',');\n  return rowKey;\n};\n/**\n * 使用map 来删除数据，性能一般 但是准确率比较高\n *\n * @param params\n * @param action\n */\n\nfunction editableRowByKey(params, action) {\n  var _recordKeyToString;\n\n  var getRowKey = params.getRowKey,\n      row = params.row,\n      data = params.data,\n      childrenColumnName = params.childrenColumnName;\n  var key = (_recordKeyToString = recordKeyToString(params.key)) === null || _recordKeyToString === void 0 ? void 0 : _recordKeyToString.toString();\n  var kvMap = new Map();\n  /**\n   * 打平这个数组\n   *\n   * @param records\n   * @param parentKey\n   */\n\n  function dig(records, map_row_parentKey, map_row_index) {\n    records.forEach(function (record, index) {\n      var eachIndex = (map_row_index || 0) * 10 + index;\n      var recordKey = getRowKey(record, eachIndex).toString(); // children 取在前面方便拼的时候按照反顺序放回去\n\n      if (record && _typeof(record) === 'object' && childrenColumnName in record) {\n        dig(record[childrenColumnName] || [], recordKey, eachIndex);\n      }\n\n      var newRecord = _objectSpread(_objectSpread({}, record), {}, {\n        map_row_key: recordKey,\n        children: undefined,\n        map_row_parentKey: map_row_parentKey\n      });\n\n      delete newRecord.children;\n\n      if (!map_row_parentKey) {\n        delete newRecord.map_row_parentKey;\n      }\n\n      kvMap.set(recordKey, newRecord);\n    });\n  }\n\n  if (action === 'top') {\n    kvMap.set(key, _objectSpread(_objectSpread({}, kvMap.get(key)), row));\n  }\n\n  dig(data);\n\n  if (action === 'update') {\n    kvMap.set(key, _objectSpread(_objectSpread({}, kvMap.get(key)), row));\n  }\n\n  if (action === 'delete') {\n    kvMap.delete(key);\n  }\n\n  var fill = function fill(map) {\n    var kvArrayMap = new Map();\n    var kvSource = [];\n    map.forEach(function (value) {\n      if (value.map_row_parentKey) {\n        // @ts-ignore\n        var map_row_parentKey = value.map_row_parentKey,\n            map_row_key = value.map_row_key,\n            reset = _objectWithoutProperties(value, _excluded);\n\n        if (kvArrayMap.has(map_row_key)) {\n          reset[childrenColumnName] = kvArrayMap.get(map_row_key);\n        }\n\n        kvArrayMap.set(map_row_parentKey, [].concat(_toConsumableArray(kvArrayMap.get(map_row_parentKey) || []), [reset]));\n      }\n    });\n    map.forEach(function (value) {\n      if (!value.map_row_parentKey) {\n        // @ts-ignore\n        var map_row_key = value.map_row_key,\n            rest = _objectWithoutProperties(value, _excluded2);\n\n        if (kvArrayMap.has(map_row_key)) {\n          var item = _objectSpread(_objectSpread({}, rest), {}, _defineProperty({}, childrenColumnName, kvArrayMap.get(map_row_key)));\n\n          kvSource.push(item);\n          return;\n        }\n\n        kvSource.push(rest);\n      }\n    });\n    return kvSource;\n  };\n\n  var source = fill(kvMap);\n  return source;\n}\n/**\n * 保存按钮的dom\n *\n * @param ActionRenderConfig\n */\n\n\nexport function SaveEditableAction(_ref) {\n  var recordKey = _ref.recordKey,\n      onSave = _ref.onSave,\n      form = _ref.form,\n      row = _ref.row,\n      children = _ref.children,\n      newLineConfig = _ref.newLineConfig,\n      editorType = _ref.editorType,\n      tableName = _ref.tableName;\n  var context = useContext(ProFormContext);\n\n  var _useMountMergeState = useMountMergeState(false),\n      _useMountMergeState2 = _slicedToArray(_useMountMergeState, 2),\n      loading = _useMountMergeState2[0],\n      setLoading = _useMountMergeState2[1];\n\n  return /*#__PURE__*/React.createElement(\"a\", {\n    key: \"save\",\n    onClick: /*#__PURE__*/function () {\n      var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(e) {\n        var _context$getFieldForm, isMapEditor, namePath, fields, data, res;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                e.stopPropagation();\n                e.preventDefault();\n                _context.prev = 2;\n                isMapEditor = editorType === 'Map';\n                namePath = [tableName, recordKey].map(function (key) {\n                  return key === null || key === void 0 ? void 0 : key.toString();\n                }).flat(1).filter(Boolean);\n                setLoading(true); // @ts-expect-error\n\n                _context.next = 8;\n                return form.validateFields(namePath, {\n                  recursive: true\n                });\n\n              case 8:\n                fields = ((_context$getFieldForm = context.getFieldFormatValue) === null || _context$getFieldForm === void 0 ? void 0 : _context$getFieldForm.call(context, namePath)) || form.getFieldValue(namePath);\n                data = isMapEditor ? set({}, namePath, fields, true) : fields; // 获取数据并保存\n\n                _context.next = 12;\n                return onSave === null || onSave === void 0 ? void 0 : onSave(recordKey, // 如果是 map 模式，fields 就是一个值，所以需要set 到对象中\n                // 数据模式 fields 是一个对象，所以不需要\n                merge({}, row, data), row, newLineConfig);\n\n              case 12:\n                res = _context.sent;\n                setLoading(false);\n                return _context.abrupt(\"return\", res);\n\n              case 17:\n                _context.prev = 17;\n                _context.t0 = _context[\"catch\"](2);\n                // eslint-disable-next-line no-console\n                console.log(_context.t0);\n                setLoading(false);\n                return _context.abrupt(\"return\", null);\n\n              case 22:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[2, 17]]);\n      }));\n\n      return function (_x) {\n        return _ref2.apply(this, arguments);\n      };\n    }()\n  }, loading ? /*#__PURE__*/React.createElement(LoadingOutlined, {\n    style: {\n      marginRight: 8\n    }\n  }) : null, children || '保存');\n}\n/**\n * 删除按钮 dom\n *\n * @param ActionRenderConfig\n */\n\nexport var DeleteEditableAction = function DeleteEditableAction(_ref3) {\n  var recordKey = _ref3.recordKey,\n      onDelete = _ref3.onDelete,\n      row = _ref3.row,\n      children = _ref3.children,\n      deletePopconfirmMessage = _ref3.deletePopconfirmMessage,\n      cancelEditable = _ref3.cancelEditable;\n\n  var _useMountMergeState3 = useMountMergeState(false),\n      _useMountMergeState4 = _slicedToArray(_useMountMergeState3, 2),\n      loading = _useMountMergeState4[0],\n      setLoading = _useMountMergeState4[1];\n\n  var onConfirm = /*#__PURE__*/function () {\n    var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n      var res;\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.prev = 0;\n              setLoading(true);\n              _context2.next = 4;\n              return onDelete === null || onDelete === void 0 ? void 0 : onDelete(recordKey, row);\n\n            case 4:\n              res = _context2.sent;\n              setLoading(false);\n              setTimeout(function () {\n                cancelEditable(recordKey);\n              }, 0);\n              return _context2.abrupt(\"return\", res);\n\n            case 10:\n              _context2.prev = 10;\n              _context2.t0 = _context2[\"catch\"](0);\n              // eslint-disable-next-line no-console\n              console.log(_context2.t0);\n              setLoading(false);\n              return _context2.abrupt(\"return\", null);\n\n            case 15:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2, null, [[0, 10]]);\n    }));\n\n    return function onConfirm() {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  return children !== false ? /*#__PURE__*/React.createElement(_Popconfirm, {\n    key: \"delete\",\n    title: deletePopconfirmMessage,\n    onConfirm: onConfirm\n  }, /*#__PURE__*/React.createElement(\"a\", null, loading ? /*#__PURE__*/React.createElement(LoadingOutlined, {\n    style: {\n      marginRight: 8\n    }\n  }) : null, children || '删除')) : null;\n};\n\nvar CancelEditableAction = function CancelEditableAction(props) {\n  var recordKey = props.recordKey,\n      tableName = props.tableName,\n      newLineConfig = props.newLineConfig,\n      form = props.form,\n      editorType = props.editorType,\n      onCancel = props.onCancel,\n      cancelEditable = props.cancelEditable,\n      row = props.row,\n      cancelText = props.cancelText;\n  var context = useContext(ProFormContext);\n  return /*#__PURE__*/React.createElement(\"a\", {\n    key: \"cancel\",\n    onClick: /*#__PURE__*/function () {\n      var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(e) {\n        var _context$getFieldForm2;\n\n        var isMapEditor, namePath, fields, record, res;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                e.stopPropagation();\n                e.preventDefault();\n                isMapEditor = editorType === 'Map';\n                namePath = [tableName, recordKey].flat(1).filter(Boolean);\n                fields = ((_context$getFieldForm2 = context.getFieldFormatValue) === null || _context$getFieldForm2 === void 0 ? void 0 : _context$getFieldForm2.call(context, namePath)) || form.getFieldValue(namePath);\n                record = isMapEditor ? set({}, namePath, fields) : fields;\n                _context3.next = 8;\n                return onCancel === null || onCancel === void 0 ? void 0 : onCancel(recordKey, record, row, newLineConfig);\n\n              case 8:\n                res = _context3.sent;\n                cancelEditable(recordKey);\n                /** 充值为默认值，不然编辑的行会丢掉 */\n\n                form.setFieldsValue(_defineProperty({}, recordKey, isMapEditor ? get(row, namePath) : row));\n                return _context3.abrupt(\"return\", res);\n\n              case 12:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      }));\n\n      return function (_x2) {\n        return _ref5.apply(this, arguments);\n      };\n    }()\n  }, cancelText || '取消');\n};\n\nexport function defaultActionRender(row, config) {\n  var recordKey = config.recordKey,\n      newLineConfig = config.newLineConfig,\n      saveText = config.saveText,\n      deleteText = config.deleteText;\n  return [/*#__PURE__*/React.createElement(SaveEditableAction, _extends({\n    key: \"save\"\n  }, config, {\n    row: row\n  }), saveText), (newLineConfig === null || newLineConfig === void 0 ? void 0 : newLineConfig.options.recordKey) !== recordKey ? /*#__PURE__*/React.createElement(DeleteEditableAction, _extends({\n    key: \"delete\"\n  }, config, {\n    row: row\n  }), deleteText) : null, /*#__PURE__*/React.createElement(CancelEditableAction, _extends({\n    key: \"cancel\"\n  }, config, {\n    row: row\n  }))];\n}\n/**\n * 一个方便的hooks 用于维护编辑的状态\n *\n * @param props\n */\n\nfunction useEditableArray(props) {\n  var _useState = useState(undefined),\n      _useState2 = _slicedToArray(_useState, 2),\n      newLineRecordCache = _useState2[0],\n      setNewLineRecordCache = _useState2[1];\n\n  var dataSourceKeyIndexMapRef = useRef(new Map());\n  var newLineRecordRef = useRef(undefined);\n  useDeepCompareEffect(function () {\n    var _props$dataSource;\n\n    var map = new Map();\n    (_props$dataSource = props.dataSource) === null || _props$dataSource === void 0 ? void 0 : _props$dataSource.forEach(function (record, index) {\n      var _recordKeyToString2;\n\n      map.set(index.toString(), recordKeyToString(props.getRowKey(record, -1)));\n      map.set((_recordKeyToString2 = recordKeyToString(props.getRowKey(record, -1))) === null || _recordKeyToString2 === void 0 ? void 0 : _recordKeyToString2.toString(), index.toString());\n    });\n    dataSourceKeyIndexMapRef.current = map;\n  }, [props.dataSource]); // 这里这么做是为了存上次的状态，不然每次存一下再拿\n\n  newLineRecordRef.current = newLineRecordCache;\n  var editableType = props.type || 'single';\n\n  var _useLazyKVMap = useLazyKVMap(props.dataSource, 'children', props.getRowKey),\n      _useLazyKVMap2 = _slicedToArray(_useLazyKVMap, 1),\n      getRecordByKey = _useLazyKVMap2[0];\n\n  var _useMergedState = useMergedState([], {\n    value: props.editableKeys,\n    onChange: props.onChange ? function (keys) {\n      var _props$onChange;\n\n      props === null || props === void 0 ? void 0 : (_props$onChange = props.onChange) === null || _props$onChange === void 0 ? void 0 : _props$onChange.call(props, // 计算编辑的key\n      keys, // 计算编辑的行\n      keys.map(function (key) {\n        return getRecordByKey(key);\n      }));\n    } : undefined\n  }),\n      _useMergedState2 = _slicedToArray(_useMergedState, 2),\n      editableKeys = _useMergedState2[0],\n      setEditableRowKeys = _useMergedState2[1];\n  /** 一个用来标志的set 提供了方便的 api 来去重什么的 */\n\n\n  var editableKeysSet = useMemo(function () {\n    var keys = editableType === 'single' ? editableKeys === null || editableKeys === void 0 ? void 0 : editableKeys.slice(0, 1) : editableKeys;\n    return new Set(keys);\n  }, [(editableKeys || []).join(','), editableType]);\n  var editableKeysRef = usePrevious(editableKeys);\n  /** 这行是不是编辑状态 */\n\n  var isEditable = useCallback(function (row) {\n    var _props$getRowKey, _props$getRowKey$toSt, _props$getRowKey2, _props$getRowKey2$toS;\n\n    // 为了兼容一下name 模式的 indexKey，所以需要判断两次，一次是index，一次是没有 index 的\n    var recordKeyOrIndex = (_props$getRowKey = props.getRowKey(row, row.index)) === null || _props$getRowKey === void 0 ? void 0 : (_props$getRowKey$toSt = _props$getRowKey.toString) === null || _props$getRowKey$toSt === void 0 ? void 0 : _props$getRowKey$toSt.call(_props$getRowKey); // 这里是不设置 index 的地方\n\n    var recordKey = (_props$getRowKey2 = props.getRowKey(row, -1)) === null || _props$getRowKey2 === void 0 ? void 0 : (_props$getRowKey2$toS = _props$getRowKey2.toString) === null || _props$getRowKey2$toS === void 0 ? void 0 : _props$getRowKey2$toS.call(_props$getRowKey2); // 都转化为了字符串，不然 number 和 string\n\n    var stringEditableKeys = editableKeys.map(function (key) {\n      return key.toString();\n    });\n    var stringEditableKeysRef = (editableKeysRef === null || editableKeysRef === void 0 ? void 0 : editableKeysRef.map(function (key) {\n      return key.toString();\n    })) || [];\n    var preIsEditable = props.tableName && !!(stringEditableKeysRef === null || stringEditableKeysRef === void 0 ? void 0 : stringEditableKeysRef.includes(recordKey)) || !!(stringEditableKeysRef === null || stringEditableKeysRef === void 0 ? void 0 : stringEditableKeysRef.includes(recordKeyOrIndex));\n    return {\n      recordKey: recordKey,\n      isEditable: props.tableName && (stringEditableKeys === null || stringEditableKeys === void 0 ? void 0 : stringEditableKeys.includes(recordKey)) || (stringEditableKeys === null || stringEditableKeys === void 0 ? void 0 : stringEditableKeys.includes(recordKeyOrIndex)),\n      preIsEditable: preIsEditable\n    };\n  }, [(editableKeys || []).join(',')]);\n  /**\n   * 进入编辑状态\n   *\n   * @param recordKey\n   */\n\n  var startEditable = function startEditable(recordKey) {\n    // 如果是单行的话，不允许多行编辑\n    if (editableKeysSet.size > 0 && editableType === 'single') {\n      _message.warn(props.onlyOneLineEditorAlertMessage || '只能同时编辑一行');\n\n      return false;\n    }\n\n    editableKeysSet.add(recordKey);\n    setEditableRowKeys(Array.from(editableKeysSet));\n    return true;\n  };\n  /**\n   * 退出编辑状态\n   *\n   * @param recordKey\n   */\n\n\n  var cancelEditable = function cancelEditable(recordKey, needReTry) {\n    var relayKey = recordKeyToString(recordKey).toString();\n    var key = dataSourceKeyIndexMapRef.current.get(relayKey);\n    /** 如果没找到key，转化一下再去找 */\n\n    if (!editableKeysSet.has(relayKey) && key && (needReTry !== null && needReTry !== void 0 ? needReTry : true) && props.tableName) {\n      cancelEditable(key, false);\n      return;\n    }\n    /** 如果这个是 new Line 直接删除 */\n\n\n    if (newLineRecordCache && newLineRecordCache.options.recordKey === recordKey) {\n      setNewLineRecordCache(undefined);\n    }\n\n    editableKeysSet.delete(relayKey);\n    editableKeysSet.delete(recordKeyToString(recordKey));\n    setEditableRowKeys(Array.from(editableKeysSet));\n    return true;\n  };\n\n  var onValuesChange = function onValuesChange(value, values) {\n    var _Object$keys$pop;\n\n    if (!props.onValuesChange) {\n      return;\n    }\n\n    var dataSource = props.dataSource; // 这里是把正在编辑中的所有表单数据都修改掉\n    // 不然会用 props 里面的 dataSource，数据只有正在编辑中的\n    // Object.keys(get(values, [props.tableName || ''].flat(1)) || values).forEach((recordKey) => {\n\n    editableKeys.forEach(function (eachRecordKey) {\n      if ((newLineRecordCache === null || newLineRecordCache === void 0 ? void 0 : newLineRecordCache.options.recordKey) === eachRecordKey) return;\n      var recordKey = eachRecordKey.toString(); // 如果数据在这个 form 中没有展示，也不显示\n\n      var editRow = get(values, [props.tableName || '', recordKey].flat(1).filter(function (key) {\n        return key || key === 0;\n      }));\n\n      if (!editRow) {\n        var _dataSourceKeyIndexMa;\n\n        recordKey = ((_dataSourceKeyIndexMa = dataSourceKeyIndexMapRef.current.get(recordKeyToString(recordKey))) === null || _dataSourceKeyIndexMa === void 0 ? void 0 : _dataSourceKeyIndexMa.toString()) || '';\n        editRow = get(values, [props.tableName || '', recordKey].flat(1).filter(function (key) {\n          return key || key === 0;\n        }));\n      }\n\n      if (!editRow) return;\n      dataSource = editableRowByKey({\n        data: dataSource,\n        getRowKey: props.getRowKey,\n        row: editRow,\n        key: recordKey,\n        childrenColumnName: props.childrenColumnName || 'children'\n      }, 'update');\n    });\n    var relayValue = props.tableName ? get(value, [props.tableName || ''].flat(1)) : value;\n    var recordKey = (_Object$keys$pop = Object.keys(relayValue || {}).pop()) === null || _Object$keys$pop === void 0 ? void 0 : _Object$keys$pop.toString(); //从form 和 cache 中取得数据\n\n    var newLineRecordData = _objectSpread(_objectSpread({}, newLineRecordCache === null || newLineRecordCache === void 0 ? void 0 : newLineRecordCache.defaultValue), get(values, [props.tableName || '', recordKey.toString()].flat(1).filter(function (key) {\n      return key || key === 0;\n    })));\n    /** 如果已经在 dataSource 中存在了，直接 find */\n\n\n    var editRow = dataSourceKeyIndexMapRef.current.has(recordKeyToString(recordKey)) ? dataSource.find(function (item, index) {\n      var _props$getRowKey3;\n\n      var key = (_props$getRowKey3 = props.getRowKey(item, index)) === null || _props$getRowKey3 === void 0 ? void 0 : _props$getRowKey3.toString();\n      return key === recordKey;\n    }) : newLineRecordData;\n    props.onValuesChange(editRow || newLineRecordData, dataSource);\n  };\n  /**\n   * 同时只能支持一行,取消之后数据消息，不会触发 dataSource\n   *\n   * @param row\n   * @param options\n   * @name 增加新的行\n   */\n\n\n  var addEditRecord = function addEditRecord(row, options) {\n    // 暂时不支持多行新增\n    if (newLineRecordRef.current) {\n      _message.warn(props.onlyAddOneLineAlertMessage || '只能新增一行');\n\n      return false;\n    } // 如果是单行的话，不允许多行编辑\n\n\n    if (editableKeysSet.size > 0 && editableType === 'single') {\n      _message.warn(props.onlyOneLineEditorAlertMessage || '只能同时编辑一行');\n\n      return false;\n    } // 防止多次渲染\n\n\n    var recordKey = props.getRowKey(row, props.dataSource.length);\n    editableKeysSet.add(recordKey);\n    setEditableRowKeys(Array.from(editableKeysSet)); // 如果是dataSource 新增模式的话，取消再开始编辑，\n    // 这样就可以把新增到 dataSource的数据进入编辑模式了\n    // [a,b,cache] => [a,b,c]\n\n    if ((options === null || options === void 0 ? void 0 : options.newRecordType) === 'dataSource') {\n      var _recordKeyToString3;\n\n      var actionProps = {\n        data: props.dataSource,\n        getRowKey: props.getRowKey,\n        row: _objectSpread(_objectSpread({}, row), {}, {\n          map_row_parentKey: (options === null || options === void 0 ? void 0 : options.parentKey) ? (_recordKeyToString3 = recordKeyToString(options === null || options === void 0 ? void 0 : options.parentKey)) === null || _recordKeyToString3 === void 0 ? void 0 : _recordKeyToString3.toString() : undefined\n        }),\n        key: recordKey,\n        childrenColumnName: props.childrenColumnName || 'children'\n      };\n      props.setDataSource(editableRowByKey(actionProps, (options === null || options === void 0 ? void 0 : options.position) === 'top' ? 'top' : 'update'));\n    } else {\n      setNewLineRecordCache({\n        defaultValue: row,\n        options: _objectSpread(_objectSpread({}, options), {}, {\n          recordKey: recordKey\n        })\n      });\n    }\n\n    return true;\n  }; // Internationalization\n\n\n  var intl = useIntl();\n  var saveText = (props === null || props === void 0 ? void 0 : props.saveText) || intl.getMessage('editableTable.action.save', '保存');\n  var deleteText = (props === null || props === void 0 ? void 0 : props.deleteText) || intl.getMessage('editableTable.action.delete', '删除');\n  var cancelText = (props === null || props === void 0 ? void 0 : props.cancelText) || intl.getMessage('editableTable.action.cancel', '取消');\n\n  var actionRender = function actionRender(row, form) {\n    var key = props.getRowKey(row, row.index);\n    var config = {\n      saveText: saveText,\n      cancelText: cancelText,\n      deleteText: deleteText,\n      addEditRecord: addEditRecord,\n      recordKey: key,\n      cancelEditable: cancelEditable,\n      index: row.index,\n      tableName: props.tableName,\n      newLineConfig: newLineRecordCache,\n      onCancel: function () {\n        var _onCancel = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(recordKey, editRow, originRow, newLine) {\n          var _props$onCancel;\n\n          var res;\n          return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n            while (1) {\n              switch (_context4.prev = _context4.next) {\n                case 0:\n                  _context4.next = 2;\n                  return props === null || props === void 0 ? void 0 : (_props$onCancel = props.onCancel) === null || _props$onCancel === void 0 ? void 0 : _props$onCancel.call(props, recordKey, editRow, originRow, newLine);\n\n                case 2:\n                  res = _context4.sent;\n                  return _context4.abrupt(\"return\", res);\n\n                case 4:\n                case \"end\":\n                  return _context4.stop();\n              }\n            }\n          }, _callee4);\n        }));\n\n        function onCancel(_x3, _x4, _x5, _x6) {\n          return _onCancel.apply(this, arguments);\n        }\n\n        return onCancel;\n      }(),\n      onDelete: function () {\n        var _onDelete = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(recordKey, editRow) {\n          var _props$onDelete;\n\n          var actionProps, res;\n          return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n            while (1) {\n              switch (_context5.prev = _context5.next) {\n                case 0:\n                  actionProps = {\n                    data: props.dataSource,\n                    getRowKey: props.getRowKey,\n                    row: editRow,\n                    key: recordKey,\n                    childrenColumnName: props.childrenColumnName || 'children'\n                  };\n                  _context5.next = 3;\n                  return props === null || props === void 0 ? void 0 : (_props$onDelete = props.onDelete) === null || _props$onDelete === void 0 ? void 0 : _props$onDelete.call(props, recordKey, editRow);\n\n                case 3:\n                  res = _context5.sent;\n                  props.setDataSource(editableRowByKey(actionProps, 'delete'));\n                  return _context5.abrupt(\"return\", res);\n\n                case 6:\n                case \"end\":\n                  return _context5.stop();\n              }\n            }\n          }, _callee5);\n        }));\n\n        function onDelete(_x7, _x8) {\n          return _onDelete.apply(this, arguments);\n        }\n\n        return onDelete;\n      }(),\n      onSave: function () {\n        var _onSave = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(recordKey, editRow, originRow, newLine) {\n          var _props$onSave;\n\n          var _ref6, options, res, actionProps;\n\n          return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n            while (1) {\n              switch (_context6.prev = _context6.next) {\n                case 0:\n                  _ref6 = newLine || {}, options = _ref6.options;\n                  _context6.next = 3;\n                  return props === null || props === void 0 ? void 0 : (_props$onSave = props.onSave) === null || _props$onSave === void 0 ? void 0 : _props$onSave.call(props, recordKey, editRow, originRow, newLine);\n\n                case 3:\n                  res = _context6.sent;\n                  // 保存时解除编辑模式\n                  cancelEditable(recordKey);\n\n                  if (!(newLine && (options === null || options === void 0 ? void 0 : options.recordKey) === recordKey)) {\n                    _context6.next = 8;\n                    break;\n                  }\n\n                  if ((options === null || options === void 0 ? void 0 : options.position) === 'top') {\n                    props.setDataSource([editRow].concat(_toConsumableArray(props.dataSource)));\n                  } else {\n                    props.setDataSource([].concat(_toConsumableArray(props.dataSource), [editRow]));\n                  }\n\n                  return _context6.abrupt(\"return\", res);\n\n                case 8:\n                  actionProps = {\n                    data: props.dataSource,\n                    getRowKey: props.getRowKey,\n                    row: editRow,\n                    key: recordKey,\n                    childrenColumnName: props.childrenColumnName || 'children'\n                  };\n                  props.setDataSource(editableRowByKey(actionProps, 'update'));\n                  return _context6.abrupt(\"return\", res);\n\n                case 11:\n                case \"end\":\n                  return _context6.stop();\n              }\n            }\n          }, _callee6);\n        }));\n\n        function onSave(_x9, _x10, _x11, _x12) {\n          return _onSave.apply(this, arguments);\n        }\n\n        return onSave;\n      }(),\n      form: form,\n      editableKeys: editableKeys,\n      setEditableRowKeys: setEditableRowKeys,\n      deletePopconfirmMessage: props.deletePopconfirmMessage || '删除此行？'\n    };\n    var defaultDoms = defaultActionRender(row, config);\n    if (props.actionRender) return props.actionRender(row, config, {\n      save: defaultDoms[0],\n      delete: defaultDoms[1],\n      cancel: defaultDoms[2]\n    });\n    return defaultDoms;\n  };\n\n  return {\n    editableKeys: editableKeys,\n    setEditableRowKeys: setEditableRowKeys,\n    isEditable: isEditable,\n    actionRender: actionRender,\n    startEditable: startEditable,\n    cancelEditable: cancelEditable,\n    addEditRecord: addEditRecord,\n    newLineRecord: newLineRecordCache,\n    preEditableKeys: editableKeysRef,\n    onValuesChange: onValuesChange\n  };\n}\n\nexport default useEditableArray;"]},"metadata":{},"sourceType":"module"}